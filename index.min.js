const fs=require("fs"),path=require("path"),parserJson=require("./parsers/json.js"),parserIni=require("./parsers/ini.js");class DynamicConfig{constructor(){this.doBlowOnFuse=!1,this.config=null,this.fuseList={};try{if(void 0!==process.env.CONFIG_PATH)this.path=process.env.CONFIG_PATH;else{let i=path.dirname(process.argv[1]);for(-1<i.indexOf("node_modules")&&(i=i.substring(0,i.indexOf("node_modules")-1));"/"!==i&&!fs.existsSync(path.join(i,"package.json"));){var t=i.split(path.sep);t.pop(),i=t.join(path.sep)}fs.existsSync(i+"/package.json")?this.path=i:this.path=path.dirname(process.argv[1])}this.path=fs.realpathSync(this.path)+"/"}catch(i){throw new Error("CONFIG_PATH does not exist")}try{this.pathUp=fs.realpathSync(this.path+"../")+"/"}catch(i){this.pathUp=this.path}this.script=path.basename(process.argv[1],".js"),this.env=process.env.NODE_ENV||"development",this.configSplit=process.env.CONFIG_SPLIT||null;const s=[];process.env.CONFIG_FILE&&(0==process.env.CONFIG_FILE.indexOf("/")?s.push(process.env.CONFIG_FILE):s.push(""+this.path+process.env.CONFIG_FILE));var i=["json","ini"];const n=(process.env.CONFIG_TYPE||"").toLowerCase();i.forEach(i=>{n&&n!==i||(s.push(`${this.path}config/${this.env}.`+i),s.push(`${this.pathUp}config/${this.env}.`+i),s.push(""+this.path+this.script+`/${this.env}.`+i),s.push(""+this.path+this.env+"."+i))}),i.forEach(i=>{n&&n!==i||(s.push(this.path+"config/default."+i),s.push(this.pathUp+"config/default."+i),s.push(""+this.path+this.script+"/default."+i),s.push(this.path+"default."+i))});let h=!1;this.config={},s.forEach(i=>{let t=!1;!1===h&&path.basename(i).match(/default\./)&&(t=!0);try{if((t||0===Object.keys(this.config).length)&&fs.existsSync(i)){var s=n||path.extname(i).substring(1).toLowerCase(),e=fs.readFileSync(i,"utf8");if("json"===s)this.mergeConfiguration((new parserJson).parse(e));else{if("ini"!==s)throw new Error("Unsupported file extension: "+s);this.mergeConfiguration((new parserIni).parse(e))}t&&(h=!0)}}catch(i){this.config={}}}),null===this.config&&(this.config={})}setConfiguration(i){var t=this.config;this.config={...i};const s=this;let e=!1;if(this.listFuseable(i=>{void 0!==s.fuseList[i]&&(e=!0)}),e){if(this.config=t,this.doBlowOnFuse)throw new Error(`Key ${key} already exists`);return!1}return!0}getValueKeys(i=void 0){void 0===i&&(i=this.config);const s=[];return Object.keys(i).forEach(t=>{i[t]&&"object"==typeof i[t]&&!Array.isArray(i[t])?this.getValueKeys(i[t]).forEach(i=>{s.push(t+"."+i)}):s.push(t)}),s}mergeConfiguration(t,s=void 0){return void 0===s&&(this.getValueKeys(t).forEach(i=>{if(void 0!==this.fuseList[i]){if(this.doBlowOnFuse)throw new Error(`Key ${i} already exists`);return!1}}),s=this.config),"object"!=typeof t||Array.isArray(t)?void 0===s&&(s=t):Object.keys(t).forEach(i=>{void 0===s[i]?"object"!=typeof s[i]||Array.isArray(s[i])?s[i]=t[i]:s[i]={...t[i]}:"object"!=typeof s[i]||Array.isArray(s[i])||this.mergeConfiguration(t[i],s[i])}),!0}hasEnv(i){var[,i]=this.getEnv(i);return i}hasConfig(i){var[,i]=this.getConfig(i);return i}has(i){if(Array.isArray(i)){for(const t of i)if(this.has(t))return!0;return!1}return this.hasEnv(i)||this.hasConfig(i)}getEnv(i,t=null){return void 0!==process.env[i]?[process.env[i],!0]:[t,!1]}getConfig(t,s=null){if(void 0===t)return[this.config,!0];if(void 0!==this.config[t])return[this.config[t],!0];{if("string"!=typeof t)return[s,!1];if("__configSplit"===t)return[this.configSplit||this.config.__configSplit||".",!0];var e=t.split(this.configSplit||this.config.__configSplit||".");let i=this.config;for(;0<e.length;){var n=e.shift();if(void 0===i[n])return[s,!1];i=i[n]}return void 0!==i?[i,!0]:[s,!1]}}get(i,t=null,s=!1){if(Array.isArray(i)){for(const h of i)if(this.has(h))return this.get(h)}else{var[e,n]=this.getEnv(i,t);if(n)return e;var[n,e]=this.getConfig(i,t);if(e)return n}if(s)throw new Error(`Key ${i} not found`);return t}getAsString(i,t=null,s=!1){i=this.get(i,t,s);return null===i?"":i.toString()}getAsInt(i,t=null,s=!1){i=this.get(i,t,s);return null===i?0:"number"==typeof i?i:"boolean"==typeof i?i?1:0:(t=parseInt(i.toString()),isNaN(t)?0:t)}getAsFloat(i,t=null,s=!1){i=this.get(i,t,s);return null===i?0:"number"==typeof i?i:"boolean"==typeof i?i?1:0:(t=parseFloat(i.toString()),isNaN(t)?0:t)}getAsBoolean(i,t=null,s=!1){i=this.get(i,t,s);return null!==i&&("number"!=typeof i&&"boolean"==typeof i?i:!!i)}set(t,s){if("string"!=typeof t){if(!0!==this.fuseList[t])this.config[t]=s;else if(this.doBlowOnFuse)throw new Error(`Key ${t} is fused`)}else{var e=t.split(this.configSplit||this.config.__configSplit||".");if(!0===this.fuseList[e.join(".")]){if(this.doBlowOnFuse)throw new Error(`Key ${t} is fused`)}else{let i=this.config;for(;1<e.length;){var n=e.shift();void 0===i[n]&&(i[n]={}),i=i[n]}t=e.shift();void 0===s?delete i[t]:i[t]=s}}}envPopulate(i){const[t,s]=this.getConfig(i);s&&("object"==typeof t?Object.keys(t).forEach(i=>{!1===this.hasEnv(i)&&(process.env[i]=t[i])}):!1===this.hasEnv(i)&&(process.env[i]=t))}addFuse(...i){i.forEach(i=>{Array.isArray(i)?i.forEach(i=>{i=i.split(this.configSplit||this.config.__configSplit||".").join("."),this.fuseList[i]=!0}):("string"==typeof i&&(i=i.split(this.configSplit||this.config.__configSplit||".").join(".")),this.fuseList[i]=!0)})}fuseAll(s=void 0,e=""){void 0===s&&(s=this.config),Object.keys(s).forEach(i=>{let t=i;""!==e&&(t=""+e+(this.configSplit||this.config.__configSplit||".")+i),this.addFuse(t),s[i]===Object(s[i])&&this.fuseAll(s[i],t)})}listFuseable(s,e=void 0,n=""){void 0===e&&(e=this.config),Object.keys(e).forEach(i=>{let t=i;""!==n&&(t=""+n+(this.configSplit||this.config.__configSplit||".")+t),e[i]===Object(e[i])?(s(t),this.listFuseable(s,e[i],t)):s(t)})}setBlowOnFuse(){this.doBlowOnFuse=!0}blowOnFuse(){return this.doBlowOnFuse}getSplit(){return this.configSplit||this.config.__configSplit||"."}setSplit(i){this.configSplit=i}chain(){return new DynamicChain(this)}}class DynamicChain{config=void 0;chainValue=void 0;constructor(i){this.config=i,this.chainValue=void 0}reset(){return this.chainValue=void 0,this}is(t,s){if(Array.isArray(t)){let i=!1;for(const e of t)if(i=i||this.config.get(e)===s)break;void 0===this.chainValue?this.chainValue=i:this.chainValue=this.chainValue&&i}else void 0===this.chainValue?this.chainValue=this.config.get(t)===s:this.chainValue=this.chainValue&&this.config.get(t)===s;return this}isNot(t,s){if(Array.isArray(t)){let i=!0;for(const e of t)i=i&&this.config.get(e)!==s;void 0===this.chainValue?this.chainValue=i:this.chainValue=this.chainValue&&i}else void 0===this.chainValue?this.chainValue=this.config.get(t)!==s:this.chainValue=this.chainValue&&this.config.get(t)!==s;return this}hasNotKey(t){if(Array.isArray(t)){let i=!0;for(const s of t)i=i&&!1===this.config.has(s);void 0===this.chainValue?this.chainValue=i:this.chainValue=this.chainValue&&i}else void 0===this.chainValue?this.chainValue=!1===this.config.has(t):this.chainValue=this.chainValue&&!1===this.config.has(t);return this}hasKey(t){if(Array.isArray(t)){let i=!1;for(const s of t)if(i=i||this.config.has(s))break;void 0===this.chainValue?this.chainValue=i:this.chainValue=this.chainValue&&i}else void 0===this.chainValue?this.chainValue=this.config.has(t):this.chainValue=this.chainValue&&this.config.has(t);return this}result(){return this.chainValue}}const dynamicConfig=new DynamicConfig;module.exports=dynamicConfig,module.exports.DynamicConfig=DynamicConfig,module.exports.DynamicChain=DynamicChain,module.exports.default=dynamicConfig;