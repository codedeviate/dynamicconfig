const fs=require("fs"),path=require("path"),parserJson=require("./parsers/json.js"),parserIni=require("./parsers/ini.js");class DynamicConfig{constructor(){this.blowOnFuse=!1,this.config=null,this.fuseList={};try{if(void 0!==process.env.CONFIG_PATH)this.path=process.env.CONFIG_PATH;else{let t=path.dirname(process.argv[1]);for(-1<t.indexOf("node_modules")&&(t=t.substring(0,t.indexOf("node_modules")-1));"/"!==t&&!fs.existsSync(path.join(t,"package.json"));){var i=t.split(path.sep);i.pop(),t=i.join(path.sep)}fs.existsSync(t+"/package.json")?this.path=t:this.path=path.dirname(process.argv[1])}this.path=fs.realpathSync(this.path)+"/"}catch(t){throw new Error("CONFIG_PATH does not exist")}try{this.pathUp=fs.realpathSync(this.path+"../")+"/"}catch(t){this.pathUp=this.path}this.script=path.basename(process.argv[1],".js"),this.env=process.env.NODE_ENV||"development",this.configSplit=process.env.CONFIG_SPLIT||null;const s=[];process.env.CONFIG_FILE&&(0==process.env.CONFIG_FILE.indexOf("/")?s.push(process.env.CONFIG_FILE):s.push(""+this.path+process.env.CONFIG_FILE));var t=["json","ini"];const n=(process.env.CONFIG_TYPE||"").toLowerCase();t.forEach(t=>{n&&n!==t||(s.push(`${this.path}config/${this.env}.`+t),s.push(`${this.pathUp}config/${this.env}.`+t),s.push(""+this.path+this.script+`/${this.env}.`+t),s.push(""+this.path+this.env+"."+t))}),t.forEach(t=>{n&&n!==t||(s.push(this.path+"config/default."+t),s.push(this.pathUp+"config/default."+t),s.push(""+this.path+this.script+"/default."+t),s.push(this.path+"default."+t))});let o=!1;this.config={},s.forEach(t=>{let i=!1;!1===o&&path.basename(t).match(/default\./)&&(i=!0);try{if((i||0===Object.keys(this.config).length)&&fs.existsSync(t)){var s=n||path.extname(t).substring(1).toLowerCase(),e=fs.readFileSync(t,"utf8");if("json"===s)this.mergeConfiguration((new parserJson).parse(e));else{if("ini"!==s)throw new Error("Unsupported file extension: "+s);this.mergeConfiguration((new parserIni).parse(e))}i&&(o=!0)}}catch(t){this.config={}}}),null===this.config&&(this.config={})}setConfiguration(t){var i=this.config;this.config={...t};const s=this;let e=!1;if(this.listFuseable(t=>{void 0!==s.fuseList[t]&&(e=!0)}),e){if(this.config=i,this.blowOnFuse)throw new Error(`Key ${key} already exists`);return!1}return!0}getValueKeys(t=void 0){void 0===t&&(t=this.config);const s=[];return Object.keys(t).forEach(i=>{t[i]&&"object"==typeof t[i]&&!Array.isArray(t[i])?this.getValueKeys(t[i]).forEach(t=>{s.push(i+"."+t)}):s.push(i)}),s}mergeConfiguration(i,s=void 0){return void 0===s&&(this.getValueKeys(i).forEach(t=>{if(void 0!==this.fuseList[t]){if(this.blowOnFuse)throw new Error(`Key ${t} already exists`);return!1}}),s=this.config),"object"!=typeof i||Array.isArray(i)?void 0===s&&(s=i):Object.keys(i).forEach(t=>{void 0===s[t]?"object"!=typeof s[t]||Array.isArray(s[t])?s[t]=i[t]:s[t]={...i[t]}:"object"!=typeof s[t]||Array.isArray(s[t])||this.mergeConfiguration(i[t],s[t])}),!0}hasEnv(t){var[,t]=this.getEnv(t);return t}hasConfig(t){var[,t]=this.getConfig(t);return t}has(t){return this.hasEnv(t)||this.hasConfig(t)}getEnv(t,i=null){return void 0!==process.env[t]?[process.env[t],!0]:[i,!1]}getConfig(i,s=null){if(void 0===i)return[this.config,!0];if(void 0!==this.config[i])return[this.config[i],!0];{if("__configSplit"===i)return[this.configSplit||this.config.__configSplit||".",!0];var e=i.split(this.configSplit||this.config.__configSplit||".");let t=this.config;for(;0<e.length;){var n=e.shift();if(void 0===t[n])return[s,!1];t=t[n]}return void 0!==t?[t,!0]:[s,!1]}}get(t,i=null,s=!1){var[e,n]=this.getEnv(t,i);if(n)return e;var[n,e]=this.getConfig(t,i);if(e)return n;if(s)throw new Error(`Key ${t} not found`);return i}getAsString(t,i=null,s=!1){t=this.get(t,i,s);return null===t?"":t.toString()}getAsInt(t,i=null,s=!1){t=this.get(t,i,s);return null===t?0:"number"==typeof t?t:"boolean"==typeof t?t?1:0:(i=parseInt(t.toString()),isNaN(i)?0:i)}getAsFloat(t,i=null,s=!1){t=this.get(t,i,s);return null===t?0:"number"==typeof t?t:"boolean"==typeof t?t?1:0:(i=parseFloat(t.toString()),isNaN(i)?0:i)}getAsBoolean(t,i=null,s=!1){t=this.get(t,i,s);return null!==t&&("number"!=typeof t&&"boolean"==typeof t?t:!!t)}set(i,s){var e=i.split(this.configSplit||this.config.__configSplit||".");if(!0===this.fuseList[e.join(".")]){if(this.blowOnFuse)throw new Error(`Key ${i} is fused`)}else{let t=this.config;for(;1<e.length;){var n=e.shift();void 0===t[n]&&(t[n]={}),t=t[n]}i=e.shift();void 0===s?delete t[i]:t[i]=s}}envPopulate(t){const[i,s]=this.getConfig(t);s&&("object"==typeof i?Object.keys(i).forEach(t=>{!1===this.hasEnv(t)&&(process.env[t]=i[t])}):!1===this.hasEnv(t)&&(process.env[t]=i))}addFuse(...t){t.forEach(t=>{Array.isArray(t)?t.forEach(t=>{t=t.split(this.configSplit||this.config.__configSplit||".").join("."),this.fuseList[t]=!0}):(t=t.split(this.configSplit||this.config.__configSplit||".").join("."),this.fuseList[t]=!0)})}fuseAll(s=void 0,e=""){void 0===s&&(s=this.config),Object.keys(s).forEach(t=>{let i=t;""!==e&&(i=""+e+(this.configSplit||this.config.__configSplit||".")+t),this.addFuse(i),s[t]===Object(s[t])&&this.fuseAll(s[t],i)})}listFuseable(s,e=void 0,n=""){void 0===e&&(e=this.config),Object.keys(e).forEach(t=>{let i=t;""!==n&&(i=""+n+(this.configSplit||this.config.__configSplit||".")+i),e[t]===Object(e[t])?(s(i),this.listFuseable(s,e[t],i)):s(i)})}setBlowOnFuse(){this.blowOnFuse=!0}blowOnFuse(){return this.blowOnFuse}getSplit(){return this.configSplit}setSplit(t){this.configSplit=t}}const dynamicConfig=module.exports=new DynamicConfig;